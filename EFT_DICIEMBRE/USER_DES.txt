USER_DES
/*BLOQUE 3
CASO2: INFORME DE REMUNERACIONES*/

--INSERSION MASIVA USANDO SELECT Y JOINS
INSERT INTO CARTOLA_PROFESIONALES(
    RUT_PROFESIONAL,
    NOMBRE_PROFESIONAL,
    PROFESION,
    ISAPRE,
    SUELDO_BASE,
    PORC_COMISION_PROFESIONAL,
    VALOR_TOTAL_COMISION,
    PORCENTATE_HONORARIO,
    BONO_MOVILIZACION,
    TOTAL_PAGAR
)
SELECT
    P.RUTPROF,
    INITCAP(P.NOMPRO || ' ' || P.APPPRO || ' ' || P.APMPRO) AS NOMBRE,
    PR.NOMPROFESION,
    I.NOMISAPRE,
    P.SUELDO,
    NVL(P.COMISION, 0),
    --CALCULO DEL VALOR COMISION
    ROUND(P.SUELDO * NVL(P.COMISION, 0)) AS VAL_COMISION,
    --CACULO DE MONTO DE HONORARIOS
    ROUND(P.SUELDO * (NVL(RS.HONOR_PCT, 0) /100 )) AS VAL_HONORARIO,
    --CALCULO BONO MOVILIZACION
    CASE TC.NOMTCONTRATO
        WHEN 'Indefinido Jornada Completa' THEN 150000
        WHEN 'Indefinido Jornada Parcial' THEN 120000
        WHEN 'Plazo Fijo' THEN 60000
        WHEN 'Honorarios' THEN 50000
        ELSE 0
    END AS BONO_MOV,
    --TOTAL A PAGAR
    ROUND(
        P.SUELDO +
        (P.SUELDO * NVL(P.COMISION, 0)) +
        (P.SUELDO * (NVL(RS.HONOR_PCT, 0) /100)) +
        CASE TC.NOMTCONTRATO
            WHEN 'Indefinido Jornada Completa' THEN 150000
            WHEN 'Indefinido Jornada Parcial'  THEN 120000
            WHEN 'Plazo fijo'                  THEN 60000
            WHEN 'Honorarios'                  THEN 50000
            ELSE 0
        END
    ) AS TOTAL
FROM PROFESIONAL P
    JOIN PROFESION PR ON P.IDPROFESION = PR.IDPROFESION
    JOIN ISAPRE I ON P.IDISAPRE = I.IDISAPRE
    JOIN TIPO_CONTRATO TC ON P.IDTCONTRATO = TC.IDTCONTRATO
-- JOIN NONEQUI PARA BUSCAR EL RANDO DE SUELDO
    LEFT JOIN RANGOS_SUELDOS RS ON P.SUELDO BETWEEN RS.S_MIN AND RS.S_MAX
ORDER BY
    PR.NOMPROFESION,
    P.SUELDO DESC,
    P.COMISION,
    P.RUTPROF;
COMMIT;

-- 2. DAR PERMISO AL CONSULTOR
GRANT SELECT ON CARTOLA_PROFESIONALES TO PRY2205_EFT_CON;


-- VALIDAMOS CON AL VISTA DE LA TABLA
SELECT * FROM CARTOLA_PROFESIONALES;
