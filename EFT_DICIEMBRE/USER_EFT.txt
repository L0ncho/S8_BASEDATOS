USER_EFT
CREA EL POBLAMIENTO PRIMERO !
/*----------------------------------------------------------------------------
BLOQUE 2: SINONIMOS Y PERMISOS
--------------------------------------------------------------------------------*/

--1. CREAMOS SINONIMOS PUBLICOS, PARA OCULTAR EL ESQUEMA DUEÑO
CREATE OR REPLACE PUBLIC SYNONYM PROFESIONAL FOR PRY2205_EFT.PROFESIONAL; 
CREATE OR REPLACE PUBLIC SYNONYM ASESORIA FOR PRY2205_EFT.ASESORIA;
CREATE OR REPLACE PUBLIC SYNONYM EMPRESA FOR PRY2205_EFT.EMPRESA;
CREATE OR REPLACE PUBLIC SYNONYM COMUNA FOR PRY2205_EFT.COMUNA;
CREATE OR REPLACE PUBLIC SYNONYM PROFESION FOR PRY2205_EFT.PROFESION;
CREATE OR REPLACE PUBLIC SYNONYM AFP FOR PRY2205_EFT.AFP;
CREATE OR REPLACE PUBLIC SYNONYM ISAPRE FOR PRY2205_EFT.ISAPRE;
CREATE OR REPLACE PUBLIC SYNONYM RANGOS_SUELDOS FOR PRY2205_EFT.RANGOS_SUELDOS;
CREATE OR REPLACE PUBLIC SYNONYM TIPO_CONTRATO FOR PRY2205_EFT.TIPO_CONTRATO;
CREATE OR REPLACE PUBLIC SYNONYM CARTOLA_PROFESIONALES FOR PRY2205_EFT.CARTOLA_PROFESIONALES;
CREATE OR REPLACE PUBLIC SYNONYM VW_EMPRESAS_ASESORADAS FOR PRY2205_EFT.VW_EMPRESAS_ASESORADAS;


/* 2. DAMOS PERMISOS A LOS ROLES
EL DESARROLLADOR (CON ROL_D) NECESITA LLER LAS TABLAS BASE Y ESCRIBIR EN LA CARTOLA
*/
 GRANT SELECT ON PROFESIONAL TO PRY2205_ROL_D;
 GRANT SELECT ON PROFESION TO PRY2205_ROL_D;
 GRANT SELECT ON ISAPRE TO PRY2205_ROL_D;
 GRANT SELECT ON TIPO_CONTRATO TO PRY2205_ROL_D;
 GRANT SELECT ON RANGOS_SUELDOS TO PRY2205_ROL_D;

 
 --PERMISO TOTAL SOBRE LA TABLA DE REPORTE PARA EL DESARROLLADOR
 GRANT SELECT, INSERT, UPDATE, DELETE ON CARTOLA_PROFESIONALES TO PRY2205_ROL_D;
 
 --PERMISO PARA QUE DESARROLLADOR HAGA VIVISBLE PARA DEMAS USUARIOS
 GRANT SELECT ON CARTOLA_PROFESIONALES TO PRY2205_EFT_DES WITH GRANT OPTION;

 /*-------------------------------------------------------------------------------------------------------------------------------
 -------------------------------------------------------------------------------------------------------------------------------*/
 /*BLOQUE 4: USER_EFT
 VISTA DE EMPRESAS Y PROMOCIONES
 OPTIMIZACION DE INDICES*/
 
 -- CREAREMOS LAS VISTAS CON LA LOGICA DE NEGOCIOS
CREATE OR REPLACE VIEW VW_EMPRESAS_ASESORADAS AS
SELECT
    -- RUT con formato 
    TO_CHAR(E.RUT_EMPRESA, 'FM99G999G999') || '-' || E.DV_EMPRESA AS "RUT_EMPRESA",
    E.NOMEMPRESA AS "NOMBRE_EMPRESA",
    E.IVA_DECLARADO AS "IVA",
    -- AÑOS EXISTENCIA
    EXTRACT(YEAR FROM SYSDATE) - EXTRACT(YEAR FROM E.FECHA_INICIACION_ACTIVIDADES) AS "ANIOS_EXISTENCIA",
    
    -- TOTAL ASEOSIRAS
    ROUND(COUNT(A.RUTPROF) / 12) AS "TOTAL_ASESORIAS_ANUALES",    
    --DEVOLUCION IVA
    ROUND((E.IVA_DECLARADO * ROUND(COUNT(A.RUTPROF)/12))/100) AS "DEVOLUCION_IVA",
    
    -- TIPO CLIENTE
    CASE 
        WHEN ROUND(COUNT(A.RUTPROF)/12) > 5 THEN 'CLIENTE PREMIUM'
        WHEN ROUND(COUNT(A.RUTPROF)/12) BETWEEN 3 AND 5 THEN 'CLIENTE'
        ELSE 'CLIENTE POCO CONCURRIDO'
    END AS "TIPO_CLIENTE",
    
    -- PROMOCIONES
    CASE
        WHEN ROUND(COUNT(A.RUTPROF)/12) > 5 THEN
            CASE
                WHEN ROUND(COUNT(A.RUTPROF)/12) >= 7 THEN '1 ASESORIA GRATIS'
                ELSE '1 ASESORIA 40% DE DESCUENTO'
            END
        WHEN ROUND(COUNT(A.RUTPROF)/12) BETWEEN 3 AND 5 THEN
            CASE
                WHEN ROUND(COUNT(A.RUTPROF)/12) = 5 THEN '1 ASESORIA 30% DE DESCUENTO'
                ELSE '1 ASESORIA 20% DE DESCUENTO'
            END
        ELSE 'CAPTAR CLIENTE'
    END AS "CORRESPONDE"

FROM EMPRESA E
    JOIN ASESORIA A ON E.IDEMPRESA = A.IDEMPRESA
WHERE
    EXTRACT(YEAR FROM A.FIN) = EXTRACT(YEAR FROM SYSDATE) - 1
GROUP BY
    E.RUT_EMPRESA, E.DV_EMPRESA, E.NOMEMPRESA, E.IVA_DECLARADO, E.FECHA_INICIACION_ACTIVIDADES
ORDER BY
    E.NOMEMPRESA ASC;
    
    
--VALIDESMO PROBANDO ANTES DE REALIZAR LO INDEX CON F10


--OPTMIZACION, INDICE BASADO EN FUNCION PARA ACELERAR EL FILTRO DE AÑO
CREATE INDEX IDX_ASESORIA_ANIO_FIN ON ASESORIA(EXTRACT(YEAR FROM FIN));
--ADEMAS ENTRE EMPRESA Y ASESORIA USANDO ESTE INDICE ACELERA DRASTICAMENTE EL CRUCE DE DATOS EVIATNDO RECORRIDO INNECESARIOS
CREATE INDEX IDX_ASESORIA_EMPRESA_FK ON ASESORIA(IDEMPRESA);

-- DAR PERMISO AL CONSULTOR PARA QUE PUEDA VER EL INFORME
GRANT SELECT ON VW_EMPRESAS_ASESORADAS TO PRY2205_ROL_C;

COMMIT;

-- VALIDACION
SELECT * FROM VW_EMPRESAS_ASESORADAS;
